From b9121fe7602a560c4fee9ab353a7f57a3988ec73 Mon Sep 17 00:00:00 2001
From: usa <usa@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Wed, 28 Mar 2018 10:37:07 +0000
Subject: [PATCH] merge revision(s) 62992:

	pack.c: fix underflow

	* pack.c (pack_unpack_internal): get rid of underflow.
	  https://hackerone.com/reports/298246

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_3@62997 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog              | 7 +++++++
 pack.c                 | 2 +-
 test/ruby/test_pack.rb | 3 +++
 version.h              | 2 +-
 4 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/pack.c b/pack.c
index e27eeef6ccc9..1eceee0af679 100644
--- a/pack.c
+++ b/pack.c
@@ -1235,7 +1235,7 @@ pack_unpack(VALUE str, VALUE fmt)
 	else if (ISDIGIT(*p)) {
 	    errno = 0;
 	    len = STRTOUL(p, (char**)&p, 10);
-	    if (errno) {
+	    if (len < 0 || errno) {
 		rb_raise(rb_eRangeError, "pack length too big");
 	    }
 	}
diff --git a/test/ruby/test_pack.rb b/test/ruby/test_pack.rb
index b0fd0b7158c7..b59faec9f3bc 100644
--- a/test/ruby/test_pack.rb
+++ b/test/ruby/test_pack.rb
@@ -548,6 +548,9 @@ def test_pack_unpack_atmark
     assert_equal([1, 2], "\x01\x00\x00\x02".unpack("C@3C"))
     assert_equal([nil], "\x00".unpack("@1C")) # is it OK?
     assert_raise(ArgumentError) { "\x00".unpack("@2C") }
+
+    pos = (1 << [nil].pack("p").bytesize * 8) - 100 # -100
+    assert_raise(RangeError) {"0123456789".unpack("@#{pos}C10")}
   end
 
   def test_pack_unpack_percent
