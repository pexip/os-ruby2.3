From 634232aab57007bbad5c4bad0147d5c965f01d25 Mon Sep 17 00:00:00 2001
From: usa <usa@b2dd03c8-39d4-4d8f-98ff-823fe69b080e>
Date: Wed, 28 Mar 2018 10:32:32 +0000
Subject: [PATCH] merge revision(s) 62991:

	unixsocket.c: check NUL bytes

	* ext/socket/unixsocket.c (rsock_init_unixsock): check NUL bytes.
	  https://hackerone.com/reports/302997

git-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_3@62996 b2dd03c8-39d4-4d8f-98ff-823fe69b080e
---
 ChangeLog                |  7 +++++++
 ext/socket/unixsocket.c  |  2 +-
 test/socket/test_unix.rb | 10 ++++++++++
 version.h                |  2 +-
 4 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/ext/socket/unixsocket.c b/ext/socket/unixsocket.c
index f73f12777c22..32f7e33248ac 100644
--- a/ext/socket/unixsocket.c
+++ b/ext/socket/unixsocket.c
@@ -33,7 +33,7 @@ rsock_init_unixsock(VALUE sock, VALUE path, int server)
     int fd, status;
     rb_io_t *fptr;
 
-    SafeStringValue(path);
+    FilePathValue(path);
 
     INIT_SOCKADDR_UN(&sockaddr, sizeof(struct sockaddr_un));
     if (sizeof(sockaddr.sun_path) < (size_t)RSTRING_LEN(path)) {
diff --git a/test/socket/test_unix.rb b/test/socket/test_unix.rb
index 3fe7fb368b1e..26aff187613c 100644
--- a/test/socket/test_unix.rb
+++ b/test/socket/test_unix.rb
@@ -285,6 +285,16 @@ def bound_unix_socket(klass)
     File.unlink path if path && File.socket?(path)
   end
 
+  def test_open_nul_byte
+    tmpfile = Tempfile.new("s")
+    path = tmpfile.path
+    tmpfile.close(true)
+    assert_raise(ArgumentError) {UNIXServer.open(path+"\0")}
+    assert_raise(ArgumentError) {UNIXSocket.open(path+"\0")}
+  ensure
+    File.unlink path if path && File.socket?(path)
+  end
+
   def test_addr
     bound_unix_socket(UNIXServer) {|serv, path|
       UNIXSocket.open(path) {|c|
